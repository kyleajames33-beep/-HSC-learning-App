<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSC Learning App - Performance Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f7;
            line-height: 1.6;
            color: #1d1d1f;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            margin-top: 0.5rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1d1d1f;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .status-healthy {
            background-color: #d4edda;
            color: #155724;
        }

        .status-warning {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-critical {
            background-color: #f8d7da;
            color: #721c24;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .metric {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #007aff;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .agent-list {
            list-style: none;
            margin: 1rem 0;
        }

        .agent-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e5e7;
        }

        .agent-item:last-child {
            border-bottom: none;
        }

        .agent-name {
            font-weight: 500;
        }

        .agent-metrics {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
        }

        .chart-container {
            height: 300px;
            margin: 1rem 0;
        }

        .alerts-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .alert-critical {
            background-color: #fff5f5;
            border-left-color: #f56565;
        }

        .alert-warning {
            background-color: #fffbf0;
            border-left-color: #ed8936;
        }

        .alert-info {
            background-color: #f0f9ff;
            border-left-color: #4299e1;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .alert-severity {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .alert-time {
            font-size: 0.8rem;
            color: #666;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #666;
        }

        .hsc-banner {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            text-align: center;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            font-weight: 600;
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .refresh-indicator.visible {
            opacity: 1;
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .connection-connected {
            background-color: #d4edda;
            color: #155724;
        }

        .connection-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .header {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŽ“ HSC Learning App Performance Monitor</h1>
        <p>Real-time monitoring of all agents and system performance</p>
    </div>

    <div class="container">
        <div id="hsc-banner" class="hsc-banner" style="display: none;">
            ðŸ”¥ HSC EXAM PERIOD ACTIVE - Enhanced monitoring enabled
        </div>

        <div class="dashboard-grid">
            <!-- System Health Card -->
            <div class="card">
                <h2>System Health</h2>
                <div id="system-status" class="loading">Loading...</div>
                <div class="metrics-grid" id="system-metrics" style="display: none;">
                    <div class="metric">
                        <div class="metric-value" id="healthy-agents">-</div>
                        <div class="metric-label">Healthy Agents</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="overall-score">-</div>
                        <div class="metric-label">Health Score</div>
                    </div>
                </div>
            </div>

            <!-- Agent Status Card -->
            <div class="card">
                <h2>Agent Status</h2>
                <ul id="agent-list" class="agent-list">
                    <li class="loading">Loading agent status...</li>
                </ul>
            </div>

            <!-- System Resources Card -->
            <div class="card">
                <h2>System Resources</h2>
                <div class="metrics-grid" id="resource-metrics">
                    <div class="metric">
                        <div class="metric-value" id="cpu-usage">-</div>
                        <div class="metric-label">CPU Usage</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="memory-usage">-</div>
                        <div class="metric-label">Memory Usage</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="resource-chart"></canvas>
                </div>
            </div>

            <!-- User Experience Card -->
            <div class="card">
                <h2>User Experience</h2>
                <div id="ux-score" class="loading">Loading UX metrics...</div>
                <div class="metrics-grid" id="ux-metrics" style="display: none;">
                    <div class="metric">
                        <div class="metric-value" id="avg-response-time">-</div>
                        <div class="metric-label">Avg Response (ms)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="error-rate">-</div>
                        <div class="metric-label">Error Rate (%)</div>
                    </div>
                </div>
            </div>

            <!-- Performance Trends Card -->
            <div class="card">
                <h2>Performance Trends</h2>
                <div class="chart-container">
                    <canvas id="trends-chart"></canvas>
                </div>
            </div>

            <!-- Active Alerts Card -->
            <div class="card">
                <h2>Active Alerts</h2>
                <div id="alerts-container" class="alerts-list">
                    <div class="loading">Loading alerts...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Indicators -->
    <div id="refresh-indicator" class="refresh-indicator">
        Refreshing data...
    </div>

    <div id="connection-status" class="connection-status connection-disconnected">
        Connecting...
    </div>

    <script>
        class PerformanceDashboard {
            constructor() {
                this.socket = null;
                this.charts = {};
                this.isConnected = false;
                this.lastUpdate = null;

                this.init();
            }

            async init() {
                this.initializeSocket();
                await this.loadInitialData();
                this.setupCharts();
                this.startPeriodicRefresh();
                this.checkHSCPeriod();
            }

            initializeSocket() {
                this.socket = io();

                this.socket.on('connect', () => {
                    console.log('Connected to monitoring server');
                    this.isConnected = true;
                    this.updateConnectionStatus();
                    this.socket.emit('subscribe-metrics');
                    this.socket.emit('subscribe-alerts');
                });

                this.socket.on('disconnect', () => {
                    console.log('Disconnected from monitoring server');
                    this.isConnected = false;
                    this.updateConnectionStatus();
                });

                this.socket.on('real-time-update', (data) => {
                    this.updateDashboard(data);
                });

                this.socket.on('metrics-update', (data) => {
                    this.updateSystemMetrics(data.systemMetrics);
                    this.updateSystemHealth(data.systemHealth);
                });

                this.socket.on('alerts-update', (data) => {
                    this.updateAlerts(data.alerts);
                });
            }

            updateConnectionStatus() {
                const statusEl = document.getElementById('connection-status');
                if (this.isConnected) {
                    statusEl.textContent = 'Connected';
                    statusEl.className = 'connection-status connection-connected';
                } else {
                    statusEl.textContent = 'Disconnected';
                    statusEl.className = 'connection-status connection-disconnected';
                }
            }

            async loadInitialData() {
                try {
                    this.showRefreshIndicator();

                    const [systemHealth, uxMetrics, alerts] = await Promise.all([
                        fetch('/api/monitoring/system-health').then(r => r.json()),
                        fetch('/api/monitoring/user-experience').then(r => r.json()),
                        fetch('/api/monitoring/alerts').then(r => r.json())
                    ]);

                    this.updateSystemHealth(systemHealth);
                    this.updateUXMetrics(uxMetrics);
                    this.updateAlerts(alerts.alerts);

                    this.hideRefreshIndicator();

                } catch (error) {
                    console.error('Failed to load initial data:', error);
                    this.hideRefreshIndicator();
                }
            }

            updateSystemHealth(data) {
                // Update overall status
                const statusEl = document.getElementById('system-status');
                const metricsEl = document.getElementById('system-metrics');

                statusEl.innerHTML = `
                    <span class="status-indicator status-${data.overallStatus}">
                        ${this.getStatusIcon(data.overallStatus)} ${data.overallStatus.toUpperCase()}
                    </span>
                `;

                // Update metrics
                document.getElementById('healthy-agents').textContent = data.healthyAgents;
                document.getElementById('overall-score').textContent = this.calculateOverallScore(data);

                metricsEl.style.display = 'grid';

                // Update agent list
                this.updateAgentList(data.agents || {});

                // Update system resources
                if (data.systemResources) {
                    this.updateSystemResources(data.systemResources);
                }
            }

            updateAgentList(agents) {
                const agentList = document.getElementById('agent-list');

                if (Object.keys(agents).length === 0) {
                    agentList.innerHTML = '<li class="agent-item">No agents found</li>';
                    return;
                }

                agentList.innerHTML = Object.entries(agents).map(([name, agent]) => `
                    <li class="agent-item">
                        <div>
                            <div class="agent-name">${name}</div>
                            <div class="agent-metrics">
                                <span class="status-indicator status-${agent.status}">
                                    ${this.getStatusIcon(agent.status)} ${agent.status}
                                </span>
                            </div>
                        </div>
                        <div class="agent-metrics">
                            <span>${agent.responseTime || 0}ms</span>
                            <span>${agent.healthScore || 0}/100</span>
                        </div>
                    </li>
                `).join('');
            }

            updateSystemResources(resources) {
                if (resources.cpu) {
                    document.getElementById('cpu-usage').textContent = `${resources.cpu.usage}%`;
                }
                if (resources.memory) {
                    document.getElementById('memory-usage').textContent = `${resources.memory.usage}%`;
                }

                // Update resource chart
                if (this.charts.resource) {
                    const now = new Date().toLocaleTimeString();
                    this.charts.resource.data.labels.push(now);
                    this.charts.resource.data.datasets[0].data.push(resources.cpu?.usage || 0);
                    this.charts.resource.data.datasets[1].data.push(resources.memory?.usage || 0);

                    // Keep only last 20 data points
                    if (this.charts.resource.data.labels.length > 20) {
                        this.charts.resource.data.labels.shift();
                        this.charts.resource.data.datasets[0].data.shift();
                        this.charts.resource.data.datasets[1].data.shift();
                    }

                    this.charts.resource.update('none');
                }
            }

            updateUXMetrics(data) {
                const uxScoreEl = document.getElementById('ux-score');
                const metricsEl = document.getElementById('ux-metrics');

                uxScoreEl.innerHTML = `
                    <div class="metric">
                        <div class="metric-value">${data.overallScore || 0}/100</div>
                        <div class="metric-label">UX Score</div>
                    </div>
                `;

                if (data.metrics) {
                    document.getElementById('avg-response-time').textContent = data.metrics.averageResponseTime || 0;
                    document.getElementById('error-rate').textContent = (data.metrics.errorRate || 0).toFixed(1);
                    metricsEl.style.display = 'grid';
                }
            }

            updateAlerts(alerts) {
                const container = document.getElementById('alerts-container');

                if (!alerts || alerts.length === 0) {
                    container.innerHTML = '<div class="loading">No active alerts</div>';
                    return;
                }

                container.innerHTML = alerts.map(alert => `
                    <div class="alert-item alert-${alert.severity}">
                        <div class="alert-header">
                            <span class="alert-severity">${alert.severity}</span>
                            <span class="alert-time">${new Date(alert.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <div>${alert.message}</div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
                            Source: ${alert.source}
                        </div>
                    </div>
                `).join('');
            }

            setupCharts() {
                // Resource usage chart
                const resourceCtx = document.getElementById('resource-chart').getContext('2d');
                this.charts.resource = new Chart(resourceCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'CPU Usage %',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.1
                        }, {
                            label: 'Memory Usage %',
                            data: [],
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });

                // Performance trends chart
                const trendsCtx = document.getElementById('trends-chart').getContext('2d');
                this.charts.trends = new Chart(trendsCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Response Time (ms)',
                            data: [],
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.1,
                            yAxisID: 'y'
                        }, {
                            label: 'Health Score',
                            data: [],
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            tension: 0.1,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: {
                                    drawOnChartArea: false,
                                },
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });
            }

            startPeriodicRefresh() {
                setInterval(() => {
                    if (!this.isConnected) {
                        this.loadInitialData();
                    }
                }, 30000); // Refresh every 30 seconds if not connected via websocket
            }

            checkHSCPeriod() {
                const examStart = new Date('2024-10-15');
                const examEnd = new Date('2024-11-15');
                const now = new Date();

                if (now >= examStart && now <= examEnd) {
                    document.getElementById('hsc-banner').style.display = 'block';
                }
            }

            getStatusIcon(status) {
                switch (status) {
                    case 'healthy': return 'âœ…';
                    case 'degraded': return 'âš ï¸';
                    case 'critical': return 'ðŸ”´';
                    case 'warning': return 'âš ï¸';
                    default: return 'â“';
                }
            }

            calculateOverallScore(data) {
                const healthyRatio = data.totalAgents > 0 ? data.healthyAgents / data.totalAgents : 0;
                return Math.round(healthyRatio * 100);
            }

            showRefreshIndicator() {
                const indicator = document.getElementById('refresh-indicator');
                indicator.classList.add('visible');
            }

            hideRefreshIndicator() {
                const indicator = document.getElementById('refresh-indicator');
                indicator.classList.remove('visible');
            }

            updateDashboard(data) {
                this.lastUpdate = new Date();

                if (data.systemHealth) {
                    this.updateSystemHealth(data.systemHealth);
                }

                if (data.systemMetrics) {
                    this.updateSystemResources(data.systemMetrics);
                }

                // Update trends chart with latest data
                if (this.charts.trends && data.systemHealth) {
                    const now = new Date().toLocaleTimeString();
                    const avgResponseTime = this.calculateAvgResponseTime(data.systemHealth.agents);
                    const healthScore = this.calculateOverallScore(data.systemHealth);

                    this.charts.trends.data.labels.push(now);
                    this.charts.trends.data.datasets[0].data.push(avgResponseTime);
                    this.charts.trends.data.datasets[1].data.push(healthScore);

                    // Keep only last 20 data points
                    if (this.charts.trends.data.labels.length > 20) {
                        this.charts.trends.data.labels.shift();
                        this.charts.trends.data.datasets[0].data.shift();
                        this.charts.trends.data.datasets[1].data.shift();
                    }

                    this.charts.trends.update('none');
                }
            }

            calculateAvgResponseTime(agents) {
                if (!agents || Object.keys(agents).length === 0) return 0;

                const responseTimes = Object.values(agents)
                    .filter(agent => agent.responseTime)
                    .map(agent => agent.responseTime);

                if (responseTimes.length === 0) return 0;

                return Math.round(responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length);
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new PerformanceDashboard();
        });
    </script>
</body>
</html>